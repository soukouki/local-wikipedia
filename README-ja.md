# Local-Wikipedia

Local-Wikipediaは、事前に情報をダウンロードする形のWikipediaの記事を検索し読むMCPサーバーです。

事前にダウンロードすることによる利点は以下の通りです。

1. Wikipediaの全文検索が可能
   - 通常のMCPサーバーでは、記事のタイトル部分を完全一致したり、リダイレクトの処理が行われる程度の検索しかできません。
   - Local-Wikipediaでは、全文データを手元に持っているため、全文検索が可能です。
2. インターネットが無い環境でも、一回データをダウンロードしてしまえば動作可能
   - ローカルにデータを保存しているため、インターネット接続が無い環境でもWikipediaの記事を検索・閲覧できます。
3. 高い検索頻度にも耐えられる
   - Web APIのレートリミットを気にせず、高頻度での検索が可能です。
   - 検索クエリを柔軟に解釈し、検索を繰り返すような用途にも適しています。
4. 全文が手元にあるので、機能追加がしやすい
   - 全文データが手元にあるため、他のMCPサーバーでは難しいような機能追加も比較的容易に行えます。
     - 他のMCPサーバーでは利用するWeb APIの制約を受けることがありますが、Local-Wikipediaではそのような制約がありません。
   - 例えば、ランダムな記事を取得する機能なども簡単に実装できます。

また、このMCPサーバーは、特にローカルLLMなどの小さいパラメータ数のモデルと組み合わせて使うことを想定しています。大規模なLLMが利用できない環境でも、Wikipediaの記事を柔軟に検索し、情報を取得できます。動作確認はGemma 3n E4Bというモバイル向けの小型モデルで行っており、CPU環境でも高速に動作します。

小型のLLMと組み合わせやすいように、以下の工夫を行っています。

1. ツールを2つに絞り、引数も最小限にすることで、LLMがツールを使いやすくしています。
2. 検索クエリのヒューリスティックな修正機能を備え、LLMが誤って余計な情報をツールに与えた場合でも、適切に検索できるようにしています。
3. 検索結果を状況に合わせて簡潔に出力し、短いコンテキスト長の制限に耐え、弱い計算資源でも高速に処理できます。
4. 高度なDBインデックス技術を利用し、高速な検索と低いメモリ使用量を実現しています。代わりに初回セットアップに時間がかかりますが、一度セットアップすれば高速に動作します。

## 機能

このMCPサーバーは以下の2つのツールを提供しています。

### search_article

指定されたタイトルの記事を柔軟に検索し、適切に出力します。LLMがツールを利用しやすいように、1つのツールに複数の検索方法を統合しています。

検索方法は以下のとおりです。

1. タイトル完全一致検索
2. リダイレクト完全一致検索
3. タイトル部分一致検索
4. リダイレクト部分一致検索
5. 本文の全文検索

1と2の場合、記事の概要部分を出力します。3、4、5の場合、最大20件までの検索結果を出力します。

また、LLMが誤って余計な検索クエリをツールに与えた場合に備え、ヒューリスティック的に検索クエリを修正する機能も備えています。

### read_random_article

指定された言語のWikipediaからランダムに記事を取得します。

## セットアップ方法

環境構築はすべてDocker Composeで行います。以下の手順に従ってセットアップしてください。

DockerとDocker Composeがインストールされていることを確認してください。

```bash
git clone https://github.com/soukouki/local-wikipedia.git
cd local-wikipedia
docker-compose up
```

初回実行時にはconfig.yamlファイルで指定された言語のWikipediaデータがダウンロードされ、インデックスが作成されます。データのダウンロードとインデックス作成には時間がかかる場合があります。日本語では数十分程度、英語では数時間程度かかります。安定した光回線にてダウンロードを行って下さい。

セットアップが完了すると、MCPサーバーが起動します。デフォルトではポート29423で待機しています。以下のような形で接続して下さい。

```json
{
  "servers": {
    "local-wikipedia": {
      "url": "http://localhost:29423"
    }
  }
}
```

## 技術的な詳細

Local-Wikipediaでは、Wikipedia自身が公開しているページ・リダイレクトに関するダンプデータと、[HuggingFaceFW/finewiki · Datasets at Hugging Face](https://huggingface.co/datasets/HuggingFaceFW/finewiki#available-subsets)にて公開されているMarkdown整形済みの全文データを利用しています。

全文検索にはPGroongaを利用し、日本語でも英語でも高速に、メモリ使用量を抑えて検索できるようにしています。

## 注意点

- 現在のLocal-Wikipediaは、APIを外部公開する形での利用を想定していません。APIを外部公開する際には、セキュリティのために適宜コードを修正することを推奨します。
- ウィキペディアのコンテンツは Creative Commons Attribution-ShareAlike 4.0 International License (CC BY-SA 4.0) および GNU Free Documentation License (GFDL) の下にライセンスされています。
